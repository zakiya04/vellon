const streamifier = require('streamifier');
const cloudinary = require('./cloudinary');

app.post('/upload', upload.single('image'), async (req, res) => {
  const streamUpload = () =>
    new Promise((resolve, reject) => {
      const stream = cloudinary.uploader.upload_stream(
        { folder: 'myapp' },
        (err, result) => {
          if (result) resolve(result);
          else reject(err);
        }
      );

      streamifier.createReadStream(req.file.buffer).pipe(stream);
    });

  const result = await streamUpload();

  res.json({
    url: result.secure_url,
    public_id: result.public_id
  });
});
